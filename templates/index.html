<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guelph Schedule Generator</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0F172A; 
            --bg-secondary: #1E293B; 
            --bg-tertiary: #334155; 
            --bg-card: #1E293B;
            --text-primary: #F1F5F9; 
            --text-secondary: #CBD5E1; 
            --text-muted: #64748B; 
            --border-color: #334155; 
            --accent-color: #F43F5E; 
            --accent-hover: #E11D48; 
            
            --course-block-lecture-bg: #F43F5E; 
            --course-block-lab-bg: #3B82F6;    
            --course-block-seminar-bg: #10B981; 

            --warning-bg: rgba(234, 179, 8, 0.1); 
            --warning-border: #F59E0B; 
            --warning-text: #FCD34D; 
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow-x: hidden; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
        }

        .main-title-section { text-align: center; margin-bottom: 2.5rem; }
        .main-title-section h1 { font-size: 2.25rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; }
        .main-title-section h1 .fa-calendar-days { color: var(--accent-color); }
        .main-title-section p { font-size: 1rem; color: var(--text-secondary); max-width: 600px; margin: 0 auto; }

        .content-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        .card-common {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        .card-header-title { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; display: flex; align-items: center; }
        .card-header-title i { margin-right: 0.75rem; color: var(--accent-color); }
        .card-description { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem; }
        
        .form-label-custom { font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem; display: block; }
        .semester-pills { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .semester-pill { padding: 0.5rem 1rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s ease; font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); display: inline-flex; align-items: center; gap: 0.3rem;}
        .semester-pill i { font-size: 0.9em; }
        .semester-pill:hover { border-color: var(--accent-color); color: var(--text-primary); }
        .semester-pill.active { background: var(--accent-color); border-color: var(--accent-color); color: white; font-weight: 600; }

        .form-control-custom, .form-select-custom { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 0.65rem 1rem; font-size: 0.9rem; width: 100%; }
        .form-control-custom:focus, .form-select-custom:focus { background: var(--bg-tertiary); border-color: var(--accent-color); box-shadow: 0 0 0 0.2rem rgba(244, 63, 94, 0.25); outline: none; }
        .form-control-custom::placeholder { color: var(--text-muted); }

        .suggestions-dropdown { background: var(--bg-secondary); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; box-shadow: var(--shadow-lg); max-height: 250px; overflow-y: auto; position: absolute; width: 100%; z-index: 1000; }
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s ease; color: var(--text-primary); font-size: 0.875rem; }
        .suggestion-item:hover { background-color: var(--bg-tertiary); }
        .suggestion-item:not(:last-child) { border-bottom: 1px solid var(--border-color); }

        .button-group { display: flex; gap: 0.75rem; margin-top: 1rem; }
        .btn-custom { padding: 0.65rem 1.25rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; transition: all 0.2s ease; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
        .btn-accent { background-color: var(--accent-color); color: white; }
        .btn-accent:hover { background-color: var(--accent-hover); }
        .btn-secondary-custom { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary-custom:hover { background-color: var(--border-color); }

        #selected-courses { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .course-tag-wrapper { position: relative; display: inline-block; } 
        .course-tag { display: inline-flex; align-items: center; background: var(--accent-color); color: white; padding: 0.3rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; }
        .course-tag .action-btn { background: rgba(255, 255, 255, 0.2); border: none; color: white; margin-left: 0.5rem; cursor: pointer; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; line-height: 1; padding:0; }
        .course-tag .action-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .course-tag .action-btn.has-constraints { background-color: var(--warning-border); }
        
        .course-time-dropdown { display: none; position: absolute; top: 110%; left: 0; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow-lg); padding: 1rem; z-index: 1010; width: 300px; }
        .course-time-dropdown h6 { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary); }
        .course-time-dropdown .time-input-group { margin-bottom: 0.75rem; }
        .course-time-dropdown .form-label-custom { font-size: 0.8rem; margin-bottom: 0.25rem; }
        .course-time-dropdown .form-control-custom { padding: 0.5rem 0.75rem; font-size: 0.85rem; }
        .course-time-dropdown .button-group { justify-content: flex-end; margin-top: 0.5rem;}
        .course-time-dropdown .button-group .btn-custom { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        .global-controls-header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1.5rem; gap: 0.75rem; }
        .global-controls-header .btn-custom { font-size: 0.875rem; padding: 0.5rem 1rem; }

        .filter-panel { background-color: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow); }
        .filter-panel h5 { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center;}
        .filter-panel h5 i { margin-right: 0.75rem; color: var(--accent-color);}
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        
        .schedules-count-header { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1.5rem; }
        .schedules-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .schedule-card-visual { background: var(--bg-card); border-radius: 12px; padding: 1rem; border: 1px solid var(--border-color); box-shadow: var(--shadow); display: flex; flex-direction: column; }
        
        .visual-schedule-display {
            display: grid;
            grid-template-columns: 30px repeat(5, 1fr); 
            grid-template-rows: auto 1fr; 
            gap: 2px;
            background-color: var(--bg-primary);
            padding: 0.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            height: 250px; 
            position: relative;
        }
        .time-label-col {
            grid-row: 2; 
            grid-column: 1;
            font-size: 0.50rem; 
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            text-align: right;
            padding-right: 4px;
        }
        .day-col-header { grid-row: 1; font-size: 0.7rem; font-weight: 600; text-align: center; padding-bottom: 0.25rem; color: var(--text-secondary); }
        .day-col-visual {
            grid-row: 2; 
            background-color: var(--bg-secondary);
            border-radius: 4px;
            position: relative; 
            background-image: repeating-linear-gradient(
                var(--bg-secondary) 0, var(--bg-secondary) calc(100% / 14 - 1px), 
                var(--border-color) calc(100% / 14 - 1px), var(--border-color) calc(100% / 14)
            );
            background-size: 100% calc(100% / 14); 
        }

        .course-block-visual { position: absolute; left: 1px; right: 1px; width: calc(100% - 2px); border-radius: 2px; overflow: hidden; box-shadow: var(--shadow-sm); display: flex; align-items: center; justify-content: center; padding: 1px; }
        .course-block-visual span { font-size: 0.45rem; color: white; line-height: 1; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .course-block-visual.lecture { background-color: var(--course-block-lecture-bg); }
        .course-block-visual.lab { background-color: var(--course-block-lab-bg); }
        .course-block-visual.seminar { background-color: var(--course-block-seminar-bg); }


        .schedule-details-list { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem; max-height: 70px; overflow-y: auto; flex-grow: 1; }
        .schedule-details-list strong { color: var(--text-primary); }
        .schedule-card-actions { display: flex; gap: 0.5rem; margin-top: auto; }
        .schedule-card-actions .btn-custom { flex-grow: 1; font-size: 0.8rem; padding: 0.4rem 0.8rem; }
        .schedule-card-actions .btn-save { background-color: var(--course-block-seminar-bg); color: white;} 
        .schedule-card-actions .btn-save:hover { opacity: 0.8; }


        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); border: 2px dashed var(--border-color); border-radius: 12px; }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        .empty-state h3 { color: var(--text-primary); font-size: 1.25rem; }
        #no-courses-selected-msg { color: var(--text-muted); font-style: italic; font-size: 0.9rem; }


        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 3000; color: var(--text-primary); }
        .loading-spinner { width: 50px; height: 50px; border: 3px solid rgba(244, 63, 94, 0.3); border-top: 3px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1.5rem; }
        .loading-overlay h4 { font-size: 1.125rem; margin-bottom: 0.5rem; }
        .loading-overlay p { font-size: 0.9rem; color: var(--text-secondary); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #saved-schedules-panel { 
            display: none; 
            margin-top: 1.5rem; 
            min-height: 200px; 
            max-height: 400px; 
            flex-direction: column;
        }
        #saved-schedules-list {
            flex-grow: 1; 
            overflow-y: auto; 
            padding-right: 0.5rem; 
        }
        .saved-schedule-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 0.5rem; }
        .saved-schedule-item-name { font-weight: 500; color: var(--text-primary); }
        .saved-schedule-item-details { font-size: 0.75rem; color: var(--text-muted); display: block; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .saved-schedule-item-actions .btn-custom { padding: 0.3rem 0.6rem; font-size: 0.75rem; }

        /* Modal specific styles */
        .modal-content { background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .modal-header { border-bottom-color: var(--border-color); }
        .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); } 
        #modal-calendar-content .visual-schedule-display { height: 500px; } 
        #modal-calendar-content .time-label-col { font-size: 0.6rem; }
<<<<<<< HEAD
        #modal-calendar-content .course-block-visual { 
            align-items: center; /* Center vertically, good for single line */
            padding: 2px 3px; 
        }
        #modal-calendar-content .course-block-visual span { 
            font-size: 0.55rem; /* Slightly larger for modal */
            font-weight: 500; /* Bolder */
            line-height: 1.2; 
            white-space: nowrap; /* Keep on one line */
            text-align: left; /* Align to left for horizontal text */
            display: block;
            width: 100%;
            text-overflow: ellipsis; /* In case it's still too long */
            overflow: hidden;
            text-shadow: 0 0 2px rgba(0,0,0,0.7); /* For better visibility */
        } 
=======
        #modal-calendar-content .course-block-visual span { font-size: 0.55rem; } 
>>>>>>> refs/remotes/main/main
        #modal-course-list-content ul { padding-left: 0; list-style: none; }
        #modal-course-list-content li { margin-bottom: 0.25rem; font-size: 0.9rem; }


        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-color); }

        @media (min-width: 768px) {
            .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        }
    </style>
</head>
<body>

    <div class="main-title-section">
        <h1><i class="fas fa-calendar-days"></i> Guelph Schedule Generator</h1>
    </div>

    <div class="content-grid">
        <div class="config-grid">
            <div class="course-search-card card-common">
                <h2 class="card-header-title"><i class="fas fa-search"></i>Course Search</h2>
                <p class="card-description">Search and add courses to build your schedule</p>
                
                <form id="schedule-form" method="POST" action="/">
                     <div class="mb-3">
                        <label for="course-input" class="form-label-custom"><i class="fas fa-book"></i> Search courses (min 3 chars)</label>
                        <div class="position-relative">
                            <input type="text" id="course-input" name="courses_search_input" class="form-control-custom" placeholder="e.g., CIS*2170, MATH*1200" autocomplete="off">
                            <div id="course-suggestions" class="suggestions-dropdown" style="display: none;"></div>
                        </div>
                        <input type="hidden" name="courses[]" id="courses-hidden-input">
                    </div>
<<<<<<< HEAD
                    <div class="mb-3"> 
=======
                    <div>
>>>>>>> refs/remotes/main/main
                        <label for="semester" class="form-label-custom">Select Semester:</label>
                        <div class="semester-pills" id="semester-pills-container">
                            <button type="button" class="semester-pill" data-semester="Summer 2025"><i class="fas fa-sun"></i>S25</button>
                            <button type="button" class="semester-pill" data-semester="Fall 2025"><i class="fas fa-leaf"></i>F25</button>
                            <button type="button" class="semester-pill" data-semester="Winter 2026"><i class="fas fa-snowflake"></i>W26</button>
                        </div>
                        <input type="hidden" name="semester" id="selected-semester" value="Summer 2025">
                    </div>

                    <input type="hidden" name="course_time_constraints" id="course-time-constraints-input" value="{}">
                    <input type="hidden" name="preferred_times" id="preferred-times" value="">


                    <div class="button-group">
                        <button type="button" class="btn-custom btn-accent" id="generate-btn">
                            <i class="fas fa-cogs"></i> Generate Schedules
                        </button>
                        <button type="button" class="btn-custom btn-secondary-custom" id="reset-form-btn">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </form>
            </div>

            <div class="selected-courses-card card-common">
                <h2 class="card-header-title"><i class="fas fa-check-square"></i>Selected Courses (<span id="selected-courses-count">0</span>)</h2>
                <p class="card-description">Courses added to your schedule builder</p>
                <div id="selected-courses">
                     <p class="text-muted" id="no-courses-selected-msg">No courses selected yet. Type to search and add.</p>
                </div>
            </div>
        </div>
        
        <div class="global-controls-header">
            <button type="button" class="btn-custom btn-secondary-custom" id="show-filters-btn">
                <i class="fas fa-filter"></i> Show Filters
            </button>
            <button type="button" class="btn-custom btn-secondary-custom" id="toggle-saved-schedules-btn">
                <i class="fas fa-star"></i> My Saved Schedules
            </button>
        </div>

        <div class="filter-panel card-common" id="filter-panel" style="display: none;">
            <h5><i class="fas fa-sliders-h"></i> Filters & Options</h5>
            <div class="filter-grid">
                <div>
                    <label for="earliest" class="form-label-custom">Earliest Start Time:</label>
<<<<<<< HEAD
                    <input type="time" id="earliest" class="form-control-custom">
                </div>
                <div>
                    <label for="latest" class="form-label-custom">Latest End Time:</label>
                    <input type="time" id="latest" class="form-control-custom">
                </div>
                <div>
                    <label for="sort-preference" class="form-label-custom">Sort Schedules By:</label>
                    <select id="sort-preference" class="form-select-custom">
=======
                    <input type="time" id="earliest" name="earliest-filter" class="form-control-custom">
                </div>
                <div>
                    <label for="latest" class="form-label-custom">Latest End Time:</label>
                    <input type="time" id="latest" name="latest-filter" class="form-control-custom">
                </div>
                <div>
                    <label for="sort-preference" class="form-label-custom">Sort Schedules By:</label>
                    <select id="sort-preference" name="sort_preference-filter" class="form-select-custom">
>>>>>>> refs/remotes/main/main
                        <option value="smart_gaps" selected>Smart Gaps (Default)</option>
                        <option value="minimal_gaps">Minimal Gaps</option>
                        <option value="fewer_days">Fewer Days</option>
                        <option value="early_start">Early Start</option>
                        <option value="late_start">Late Start</option>
                        <option value="compact">Compact Schedule</option>
                    </select>
                </div>
                <div>
                    <label for="items-per-page" class="form-label-custom">Schedules Per Page:</label>
<<<<<<< HEAD
                    <select id="items-per-page" class="form-select-custom">
=======
                    <select id="items-per-page" name="items_per_page-filter" class="form-select-custom"> {/* Changed name */}
>>>>>>> refs/remotes/main/main
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div id="saved-schedules-panel" class="card-common">
            <h2 class="card-header-title"><i class="fas fa-star"></i>My Saved Schedules</h2>
            <div id="saved-schedules-list">
                <p class="text-muted">No schedules saved yet.</p>
            </div>
        </div>


        <div class="results-display-section card-common">
            <h2 class="schedules-count-header" id="schedules-count-header">Schedules: 0</h2>
            <div id="results-content">
                <div class="empty-state" id="results-empty">
                    <i class="fas fa-calendar-alt"></i>
                    <h3>No Schedules Generated Yet</h3>
                    <p>Select courses and click "Generate Schedules" to see results.</p>
                </div>
                <div class="schedules-grid" id="schedules-grid-container" style="display: none;">
                    <!-- Visual schedule cards will be inserted here -->
                </div>
                <div class="load-more-controls mt-4 text-center" id="load-more-controls" style="display: none;">
                     <button class="btn-custom btn-accent" id="load-more-btn">Load More Schedules</button>
                     <p id="showing-results-info" class="text-muted mt-2"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Detail Modal -->
    <div class="modal fade" id="scheduleDetailModal" tabindex="-1" aria-labelledby="scheduleDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl"> 
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleDetailModalLabel">Schedule Detail</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modal-calendar-content" class="mb-3">
                        {/* Larger calendar will be injected here */}
                    </div>
                    <h6>Courses in this Schedule:</h6>
                    <div id="modal-course-list-content">
                        {/* Course list for this schedule */}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <h4>Generating Schedules...</h4>
        <p>This might take a moment.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedCourses = [];
        let courseSearchTimeout;
        let currentResultsData = null;
        let currentPage = 1;
        const schedulesPerPage = () => parseInt(document.getElementById('items-per-page').value) || 10;
        let courseTimeConstraints = {}; 
        let savedSchedules = []; 
        const SAVED_SCHEDULES_KEY = 'coursegen_saved_schedules_v3'; 

        const STORAGE_KEYS = {
            selectedCourses: 'courseGen_selectedCourses_v3',
            selectedSemester: 'courseGen_selectedSemester_v3',
            courseTimeConstraints: 'courseGen_courseTimeConstraints_v3',
            formFilters: 'courseGen_formFilters_v3'
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadSavedState(); 
            setupEventListeners();
            loadSavedSchedulesFromStorage(); 
            renderSavedSchedulesList(); 
            updateSelectedCoursesDisplay(); 
        });

        function loadSavedState() {
            const storedCourses = localStorage.getItem(STORAGE_KEYS.selectedCourses);
            if (storedCourses) selectedCourses = JSON.parse(storedCourses);

            const storedSemester = localStorage.getItem(STORAGE_KEYS.selectedSemester);
            const semesterPills = document.querySelectorAll('.semester-pill');
            let activeSemester = "Summer 2025"; 
            
            semesterPills.forEach(p => p.classList.remove('active'));
            if (storedSemester) {
                const pillToActivate = document.querySelector(`.semester-pill[data-semester="${storedSemester}"]`);
                if (pillToActivate) {
                    pillToActivate.classList.add('active');
                    activeSemester = storedSemester;
                } else { 
                    document.querySelector('.semester-pill[data-semester="Summer 2025"]').classList.add('active');
                }
            } else {
                 document.querySelector('.semester-pill[data-semester="Summer 2025"]').classList.add('active');
            }
            document.getElementById('selected-semester').value = activeSemester;


            const storedCourseConstraints = localStorage.getItem(STORAGE_KEYS.courseTimeConstraints);
            if (storedCourseConstraints) courseTimeConstraints = JSON.parse(storedCourseConstraints);
            updateCourseTimeConstraintsHiddenInput(); 
            
            const storedFilters = localStorage.getItem(STORAGE_KEYS.formFilters);
            if (storedFilters) {
                const filters = JSON.parse(storedFilters);
                if (filters.earliest) document.getElementById('earliest').value = filters.earliest;
                if (filters.latest) document.getElementById('latest').value = filters.latest;
                if (filters.sortPreference) document.getElementById('sort-preference').value = filters.sortPreference;
                if (filters.itemsPerPage) document.getElementById('items-per-page').value = filters.itemsPerPage;
            }
        }

        function saveCurrentState() {
            localStorage.setItem(STORAGE_KEYS.selectedCourses, JSON.stringify(selectedCourses));
            localStorage.setItem(STORAGE_KEYS.selectedSemester, document.getElementById('selected-semester').value);
            localStorage.setItem(STORAGE_KEYS.courseTimeConstraints, JSON.stringify(courseTimeConstraints));
            const filters = {
                earliest: document.getElementById('earliest').value,
                latest: document.getElementById('latest').value,
                sortPreference: document.getElementById('sort-preference').value,
                itemsPerPage: document.getElementById('items-per-page').value
            };
            localStorage.setItem(STORAGE_KEYS.formFilters, JSON.stringify(filters));
        }

        function setupEventListeners() {
            document.getElementById('course-input').addEventListener('input', handleCourseInput);
            document.getElementById('course-input').addEventListener('keydown', handleCourseKeydown);
            document.getElementById('generate-btn').addEventListener('click', submitForm);
            document.getElementById('reset-form-btn').addEventListener('click', resetForm);
            
            document.getElementById('show-filters-btn').addEventListener('click', toggleFilterPanel);
            document.getElementById('toggle-saved-schedules-btn').addEventListener('click', toggleSavedSchedulesPanel);

            ['earliest', 'latest', 'sort-preference', 'items-per-page'].forEach(id => {
                document.getElementById(id).addEventListener('change', saveCurrentState);
            });
            
            document.getElementById('items-per-page').addEventListener('change', () => {
                currentPage = 1; 
                if(currentResultsData) displayPaginatedResults();
                saveCurrentState(); 
            });
            document.getElementById('sort-preference').addEventListener('change', () => {
                 if(currentResultsData) { 
                    handleFormSubmit(new Event('submit'), true); 
                 }
                 saveCurrentState();
            });
            document.querySelectorAll('.semester-pill').forEach(pill => {
                pill.addEventListener('click', function() {
                    document.querySelectorAll('.semester-pill').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('selected-semester').value = this.dataset.semester;
                    saveCurrentState();
                });
            });
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#course-input') && !e.target.closest('#course-suggestions') && !e.target.closest('.course-time-dropdown')) {
                    hideSuggestions();
                    document.querySelectorAll('.course-time-dropdown').forEach(d => d.style.display = 'none');
                }
            });
            document.getElementById('load-more-btn').addEventListener('click', loadMoreSchedules);
        }
        
        function loadMoreSchedules() {
            currentPage++;
            displayPaginatedResults();
        }

        function toggleFilterPanel() {
            const filterPanel = document.getElementById('filter-panel');
            filterPanel.style.display = filterPanel.style.display === 'none' || filterPanel.style.display === '' ? 'block' : 'none';
        }
        function toggleSavedSchedulesPanel() {
            const panel = document.getElementById('saved-schedules-panel');
<<<<<<< HEAD
            panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'flex' : 'none'; 
=======
            panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'flex' : 'none'; // Use flex for column layout
>>>>>>> refs/remotes/main/main
        }
        
        function resetForm() {
            selectedCourses = [];
            courseTimeConstraints = {};
            
            document.getElementById('schedule-form').reset(); 
            document.getElementById('earliest').value = '';
            document.getElementById('latest').value = '';
            document.getElementById('sort-preference').value = 'smart_gaps';
            document.getElementById('items-per-page').value = '10';

            document.querySelectorAll('.semester-pill').forEach(p => p.classList.remove('active'));
            const defaultSemesterPill = document.querySelector('.semester-pill[data-semester="Summer 2025"]');
            if (defaultSemesterPill) defaultSemesterPill.classList.add('active');
            document.getElementById('selected-semester').value = "Summer 2025";
            
            updateSelectedCoursesDisplay(); 
            updateCourseTimeConstraintsHiddenInput(); 
            saveCurrentState(); 

            document.getElementById('results-empty').style.display = 'block';
            document.getElementById('schedules-grid-container').style.display = 'none';
            document.getElementById('schedules-count-header').textContent = 'Schedules: 0';
            document.getElementById('load-more-controls').style.display = 'none';
            currentPage = 1;
            currentResultsData = null;
        }

        function handleCourseInput() {
            const query = this.value.trim().toUpperCase();
            clearTimeout(courseSearchTimeout);
            if (query.length >= 3) { 
                courseSearchTimeout = setTimeout(() => searchCourses(query), 300);
            } else {
                hideSuggestions();
            }
        }

        function handleCourseKeydown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const courseInputEl = document.getElementById('course-input');
                const typedCourseCode = courseInputEl.value.trim().toUpperCase();
                const firstSuggestionEl = document.querySelector('#course-suggestions .suggestion-item');
                
                let courseToAdd = null;

                if (firstSuggestionEl && firstSuggestionEl.dataset.courseCode && firstSuggestionEl.dataset.courseCode.toUpperCase() === typedCourseCode) {
                    courseToAdd = firstSuggestionEl.dataset.courseCode;
                } else if (typedCourseCode && isValidCourseFormat(typedCourseCode)) {
                    courseToAdd = typedCourseCode;
                }

                if (courseToAdd && !selectedCourses.includes(courseToAdd)) {
                    addCourse(courseToAdd);
                }
                courseInputEl.value = ''; 
                hideSuggestions();
            }
        }
        
        function isValidCourseFormat(courseCode) {
            return /^[A-Z]{2,4}\*\d{4}$/.test(courseCode);
        }

        async function searchCourses(query) {
            const semester = document.getElementById('selected-semester').value;
            try {
                const response = await fetch(`/api/search-courses?q=${encodeURIComponent(query)}&semester=${encodeURIComponent(semester)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const courses = await response.json();
                displaySuggestions(courses);
            } catch (error) {
                console.error('Error searching courses:', error);
                hideSuggestions();
            }
        }

        function displaySuggestions(courses) {
            const container = document.getElementById('course-suggestions');
            if (!courses || courses.length === 0) { 
                container.innerHTML = '<div class="suggestion-item text-muted">No courses found.</div>';
            } else {
                container.innerHTML = courses.map(course => `
                    <div class="suggestion-item" data-course-code="${course.code}" onclick="selectCourse('${course.code}')">
                        <strong>${course.code}</strong> - ${course.title}
                        <div class="text-muted small">${course.sections} sections</div>
                    </div>
                `).join('');
            }
            container.style.display = 'block';
        }

        function selectCourse(courseCode) { 
            if (!selectedCourses.includes(courseCode)) {
                addCourse(courseCode);
            }
            document.getElementById('course-input').value = '';
            hideSuggestions();
        }
        
        function addCourse(courseCode) {
            if (!selectedCourses.includes(courseCode)) {
                selectedCourses.push(courseCode);
                updateSelectedCoursesDisplay();
                saveCurrentState();
            }
        }

        function removeCourse(courseCode) {
            selectedCourses = selectedCourses.filter(c => c !== courseCode);
            delete courseTimeConstraints[courseCode]; 
            updateCourseTimeConstraintsHiddenInput();
            updateSelectedCoursesDisplay();
            saveCurrentState();
        }

        function updateSelectedCoursesDisplay() {
            const container = document.getElementById('selected-courses');
            const countSpan = document.getElementById('selected-courses-count');
            const noCoursesMsg = document.getElementById('no-courses-selected-msg');

            countSpan.textContent = selectedCourses.length;
            document.getElementById('courses-hidden-input').value = selectedCourses.join(',');

            if (selectedCourses.length === 0) {
                container.innerHTML = ''; 
                if(noCoursesMsg) noCoursesMsg.style.display = 'block';
            } else {
                if(noCoursesMsg) noCoursesMsg.style.display = 'none';
                container.innerHTML = selectedCourses.map(course => {
                    const hasConstraints = courseTimeConstraints[course] && (courseTimeConstraints[course].earliest || courseTimeConstraints[course].latest);
                    const sanitizedCourseCodeId = course.replace('*', '_star_'); 
                    return `
                        <div class="course-tag-wrapper">
                            <span class="course-tag">
                                ${course}
                                <button type="button" class="action-btn course-time-config-btn ${hasConstraints ? 'has-constraints' : ''}" 
                                        onclick="toggleCourseTimeDropdown(event, '${course}')" 
                                        title="Set time preferences for ${course}">
                                    <i class="fas fa-clock"></i>
                                </button>
                                <button type="button" class="action-btn remove-btn" onclick="removeCourse('${course}')" title="Remove ${course}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </span>
                            <div class="course-time-dropdown" id="dropdown-${sanitizedCourseCodeId}">
                                <h6>Preferences for ${course}</h6>
                                <div class="time-input-group">
                                    <label class="form-label-custom">Earliest Start:</label>
                                    <input type="time" class="form-control-custom" id="earliest-${sanitizedCourseCodeId}" 
                                           value="${(courseTimeConstraints[course] && courseTimeConstraints[course].earliest) || ''}">
                                </div>
                                <div class="time-input-group">
                                    <label class="form-label-custom">Latest End:</label>
                                    <input type="time" class="form-control-custom" id="latest-${sanitizedCourseCodeId}"
                                           value="${(courseTimeConstraints[course] && courseTimeConstraints[course].latest) || ''}">
                                </div>
                                <div class="button-group">
                                    <button type="button" class="btn-custom btn-secondary-custom btn-sm" onclick="clearCourseTimeConstraint('${course}')">Clear</button>
                                    <button type="button" class="btn-custom btn-accent btn-sm" onclick="applyCourseTimeConstraint('${course}')">Apply</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function toggleCourseTimeDropdown(event, courseCode) {
            event.stopPropagation(); 
            const sanitizedCourseCodeId = courseCode.replace('*', '_star_');
            const dropdown = document.getElementById(`dropdown-${sanitizedCourseCodeId}`);
            
            document.querySelectorAll('.course-time-dropdown').forEach(d => {
                if (d.id !== dropdown.id) d.style.display = 'none';
            });

            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' || dropdown.style.display === '' ? 'block' : 'none';
            }
        }

        function applyCourseTimeConstraint(courseCode) {
            const sanitizedCourseCodeId = courseCode.replace('*', '_star_');
            const earliest = document.getElementById(`earliest-${sanitizedCourseCodeId}`).value;
            const latest = document.getElementById(`latest-${sanitizedCourseCodeId}`).value;
            
            if (!courseTimeConstraints[courseCode]) courseTimeConstraints[courseCode] = {};
            courseTimeConstraints[courseCode].earliest = earliest;
            courseTimeConstraints[courseCode].latest = latest;
            
            updateCourseTimeConstraintsHiddenInput();
            document.getElementById(`dropdown-${sanitizedCourseCodeId}`).style.display = 'none';
            updateSelectedCoursesDisplay(); 
            saveCurrentState();
        }

        function clearCourseTimeConstraint(courseCode) {
            const sanitizedCourseCodeId = courseCode.replace('*', '_star_');
            delete courseTimeConstraints[courseCode];
            document.getElementById(`earliest-${sanitizedCourseCodeId}`).value = '';
            document.getElementById(`latest-${sanitizedCourseCodeId}`).value = '';
            updateCourseTimeConstraintsHiddenInput();
            document.getElementById(`dropdown-${sanitizedCourseCodeId}`).style.display = 'none';
            updateSelectedCoursesDisplay(); 
            saveCurrentState();
        }

        function updateCourseTimeConstraintsHiddenInput() {
            document.getElementById('course-time-constraints-input').value = JSON.stringify(courseTimeConstraints);
        }

        function hideSuggestions() {
            const suggestionsEl = document.getElementById('course-suggestions');
            if (suggestionsEl) suggestionsEl.style.display = 'none';
        }

        function submitForm() {
            handleFormSubmit(new Event('submit'));
        }

        async function handleFormSubmit(e, isReSort = false) {
            if (e) e.preventDefault();
            if (selectedCourses.length === 0 && !isReSort) {
                alert('Please select at least one course.');
                return;
            }
            showLoading();
            const formData = new FormData(); 
            
            formData.append('semester', document.getElementById('selected-semester').value);
            formData.append('courses[]', selectedCourses.join(',')); 
<<<<<<< HEAD
            formData.append('course_time_constraints', document.getElementById('course-time-constraints-input').value);
            formData.append('earliest', document.getElementById('earliest').value || '');
            formData.append('latest', document.getElementById('latest').value || '');
            formData.append('sort_preference', document.getElementById('sort-preference').value);
            formData.append('preferred_times', document.getElementById('preferred-times').value || '');

=======
            formData.append('course_time_constraints', JSON.stringify(courseTimeConstraints)); 
            formData.append('earliest', document.getElementById('earliest').value || '');
            formData.append('latest', document.getElementById('latest').value || '');
            formData.append('sort_preference', document.getElementById('sort-preference').value);
            formData.append('items_per_page', document.getElementById('items-per-page').value);
            formData.append('preferred_times', document.getElementById('preferred-times').value || '');

            // console.log("Submitting FormData:", Object.fromEntries(formData));
            // console.log("Course-specific constraints being sent to backend:", formData.get('course_time_constraints'));


>>>>>>> refs/remotes/main/main
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {'X-Requested-With': 'XMLHttpRequest'},
                    body: formData
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    currentResultsData = null;
                } else {
                    currentResultsData = data; 
                    currentPage = 1; 
                }
                displayPaginatedResults();

            } catch (error) {
                console.error('Error generating schedules:', error);
                alert('An error occurred. Please try again.');
                currentResultsData = null;
                displayPaginatedResults(); 
            } finally {
                hideLoading();
            }
        }

        function displayPaginatedResults() {
            const schedulesGrid = document.getElementById('schedules-grid-container');
            const emptyState = document.getElementById('results-empty');
            const countHeader = document.getElementById('schedules-count-header');
            const loadMoreControls = document.getElementById('load-more-controls');
            const loadMoreBtn = document.getElementById('load-more-btn');
            const showingInfo = document.getElementById('showing-results-info');

            if (!currentResultsData || !currentResultsData.combinations || currentResultsData.combinations.length === 0) {
                schedulesGrid.innerHTML = '';
                schedulesGrid.style.display = 'none';
                emptyState.style.display = 'block';
                countHeader.textContent = 'Schedules: 0';
                loadMoreControls.style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            schedulesGrid.style.display = 'grid';
            
            const totalSchedules = currentResultsData.combinations.length;
            countHeader.textContent = `Schedules: ${totalSchedules}`;

            const itemsToDisplayPerPage = schedulesPerPage();
            const end = currentPage * itemsToDisplayPerPage;
            const schedulesToShowThisPagination = currentResultsData.combinations.slice(0, end);

            schedulesGrid.innerHTML = schedulesToShowThisPagination.map((combo, index) => 
                generateVisualScheduleCard(combo, index, false) 
            ).join('');

            if (end < totalSchedules) {
                loadMoreControls.style.display = 'block';
                loadMoreBtn.style.display = 'block';
            } else {
                loadMoreBtn.style.display = 'none'; 
                if (totalSchedules > 0) loadMoreControls.style.display = 'block'; 
                else loadMoreControls.style.display = 'none';
            }
            showingInfo.textContent = `Showing ${Math.min(end, totalSchedules)} of ${totalSchedules} schedules.`;
        }
        
        function generateVisualScheduleCard(combination, globalIndex, isModal = false) {
            const scheduleId = `schedule-card-${globalIndex}${isModal ? '-modal' : ''}`;
            let coursesHtml = `<ul class="list-unstyled schedule-details-list ${isModal ? 'fs-sm' : ''}">`;
            combination.courses.forEach(course => {
                const courseCodeParts = course.section_id.split('*');
                const courseCode = courseCodeParts[0] + '*' + courseCodeParts[1];
                const sectionNum = courseCodeParts[2];
                coursesHtml += `<li><strong>${courseCode} (${sectionNum})</strong>: `;
                let times = [];
                if (course.lecture) times.push(`LEC ${formatTime(course.lecture.start)}-${formatTime(course.lecture.finish)} ${course.lecture.days.join('')}`);
                if (course.seminar) times.push(`SEM ${formatTime(course.seminar.start)}-${formatTime(course.seminar.finish)} ${course.seminar.days.join('')}`);
                if (course.lab) times.push(`LAB ${formatTime(course.lab.start)}-${formatTime(course.lab.finish)} ${course.lab.days.join('')}`);
                coursesHtml += times.join(', ') + '</li>';
            });
            coursesHtml += '</ul>';

            let visualGridHtml = `<div class="visual-schedule-display ${isModal ? 'modal-calendar' : ''}">`;
            visualGridHtml += '<div class="time-label-col">';
            const calendarStartHour = 8;
            const calendarEndHour = 22; 
            for (let hour = calendarStartHour; hour <= calendarEndHour; hour++) {
                 const displayHour = hour === 12 ? 12 : hour % 12 === 0 ? (isModal ? 12 : '') : hour % 12 ; 
                 const ampm = hour < 12 || hour === 24 ? 'a' : 'p'; 
                 if (isModal || hour % 2 === 0 || hour === calendarStartHour || hour === calendarEndHour ) { 
                    visualGridHtml += `<span>${displayHour}${displayHour !== '' ? ampm : ''}</span>`;
                 } else {
                     visualGridHtml += `<span></span>`; 
                 }
            }
            visualGridHtml += '</div>';

            const daysOfWeek = ['M', 'T', 'W', 'Th', 'F'];
            daysOfWeek.forEach(dayAbbr => {
                const headerText = dayAbbr === 'Th' ? 'Th' : dayAbbr;
                visualGridHtml += `<div class="day-col-header" style="grid-column: ${daysOfWeek.indexOf(dayAbbr) + 2};">${headerText}</div>`;
            });
            
            daysOfWeek.forEach((dayAbbr, dayIndex) => {
                visualGridHtml += `<div class="day-col-visual" data-day="${dayAbbr}" style="grid-column: ${dayIndex + 2};">`;
                combination.courses.forEach(course => {
                    const courseCodeBase = course.section_id.split('*').slice(0, 2).join('*'); 
<<<<<<< HEAD
                    const sectionNumOnly = course.section_id.split('*')[2];
=======
>>>>>>> refs/remotes/main/main
                    
                    ['lecture', 'seminar', 'lab'].forEach(type => {
                        const item = course[type];
                        if (item && item.days.includes(dayAbbr)) {
                            const startHour = item.start / 60;
                            const endHour = item.finish / 60;
                            const totalCalendarHours = calendarEndHour - calendarStartHour; 

                            if (startHour < calendarEndHour && endHour > calendarStartHour) {
                                const topPercent = Math.max(0, (startHour - calendarStartHour) / totalCalendarHours * 100);
                                const clampedEndHour = Math.min(endHour, calendarEndHour);
                                const heightPercent = Math.max(0, (clampedEndHour - Math.max(startHour, calendarStartHour)) / totalCalendarHours * 100);
                                
<<<<<<< HEAD
                                let blockTextContent = courseCodeBase; // Default for main grid
                                if (isModal) {
                                    const componentTypeAbbr = type.substring(0,3).toUpperCase();
                                    const timeFormatted = `${formatTime(item.start)}-${formatTime(item.finish)}`;
                                    blockTextContent = `${courseCodeBase}*${sectionNumOnly} (${componentTypeAbbr}) ${timeFormatted}`;
                                }
=======
                                const blockText = courseCodeBase; // Use base course code for both views now
>>>>>>> refs/remotes/main/main

                                if (heightPercent > 0.1) { 
                                     visualGridHtml += `
                                        <div class="course-block-visual ${type.toLowerCase()}" 
                                             style="top: ${topPercent}%; height: ${heightPercent}%;"
                                             title="${course.section_id} ${type.toUpperCase()} ${formatTime(item.start)}-${formatTime(item.finish)}">
<<<<<<< HEAD
                                             <span>${blockTextContent}</span>
=======
                                             <span>${blockText}</span>
>>>>>>> refs/remotes/main/main
                                        </div>`;
                                }
                            }
                        }
                    });
                });
                visualGridHtml += `</div>`;
            });
            visualGridHtml += '</div>';

            if (isModal) { 
<<<<<<< HEAD
                return visualGridHtml + coursesHtml; 
=======
                return visualGridHtml + coursesHtml; // This will be further processed by viewScheduleDetail
>>>>>>> refs/remotes/main/main
            }

            return `
                <div class="schedule-card-visual" id="${scheduleId}">
                    ${visualGridHtml}
                    ${coursesHtml}
                    <div class="schedule-card-actions">
                        <button type="button" class="btn-custom btn-save btn-sm" onclick="saveCurrentSchedule(${globalIndex})"><i class="fas fa-star"></i> Save</button>
                        <button type="button" class="btn-custom btn-accent btn-sm" onclick="viewScheduleDetail(${globalIndex})">View <i class="fas fa-eye"></i></button>
                    </div>
                </div>
            `;
        }

        function viewScheduleDetail(globalIndex) {
            if (!currentResultsData || !currentResultsData.combinations[globalIndex]) return;
            const schedule = currentResultsData.combinations[globalIndex];

            const modalCalendarContent = document.getElementById('modal-calendar-content');
            const modalCourseListContent = document.getElementById('modal-course-list-content');
            const modalTitle = document.getElementById('scheduleDetailModalLabel');

            modalTitle.textContent = `Schedule Detail (Rank #${schedule.rank || (globalIndex + 1)})`;
            
<<<<<<< HEAD
=======
            // Generate HTML for modal (isModal = true)
>>>>>>> refs/remotes/main/main
            const modalContentHtml = generateVisualScheduleCard(schedule, globalIndex, true);
            const tempElement = document.createElement('div');
            tempElement.innerHTML = modalContentHtml;

<<<<<<< HEAD
            const calendarVisualForModal = tempElement.querySelector('.visual-schedule-display');
            const courseListForModal = tempElement.querySelector('.schedule-details-list'); 
=======
            // Extract calendar and course list parts
            const calendarVisualForModal = tempElement.querySelector('.visual-schedule-display');
            const courseListForModal = tempElement.querySelector('.schedule-details-list'); // Assuming this class
>>>>>>> refs/remotes/main/main

            if (calendarVisualForModal) {
                modalCalendarContent.innerHTML = calendarVisualForModal.outerHTML;
            } else {
                modalCalendarContent.innerHTML = "<p>Error generating calendar view.</p>";
            }
            if (courseListForModal) {
                modalCourseListContent.innerHTML = courseListForModal.outerHTML;
            } else {
                modalCourseListContent.innerHTML = "<p>Course details not available.</p>";
            }
            
            var scheduleModalElement = document.getElementById('scheduleDetailModal');
            var scheduleModal = bootstrap.Modal.getInstance(scheduleModalElement);
            if (!scheduleModal) {
                scheduleModal = new bootstrap.Modal(scheduleModalElement);
            }
            scheduleModal.show();
        }
        
        function loadSavedSchedulesFromStorage() {
            const stored = localStorage.getItem(SAVED_SCHEDULES_KEY);
            savedSchedules = stored ? JSON.parse(stored) : [];
        }

        function persistSavedSchedules() {
            localStorage.setItem(SAVED_SCHEDULES_KEY, JSON.stringify(savedSchedules));
        }

        function saveCurrentSchedule(globalIndexOfCombination) {
            if (!currentResultsData || !currentResultsData.combinations[globalIndexOfCombination]) {
                alert("Could not find schedule data to save.");
                return;
            }
            const scheduleToSave = currentResultsData.combinations[globalIndexOfCombination];
            
            const scheduleName = prompt("Enter a name for this schedule (e.g., My Favorite S25):", `Schedule ${savedSchedules.length + 1}`);
            if (!scheduleName) return; 

            const existingIndex = savedSchedules.findIndex(s => s.name === scheduleName);
            if (existingIndex !== -1) {
                if (!confirm(`A schedule named "${scheduleName}" already exists. Overwrite?`)) {
                    return;
                }
                savedSchedules.splice(existingIndex, 1); 
            }

            const newSavedItem = {
                id: Date.now().toString(), 
                name: scheduleName,
                timestamp: new Date().toLocaleString(),
                data: scheduleToSave 
            };
            savedSchedules.unshift(newSavedItem); 
            persistSavedSchedules();
            renderSavedSchedulesList();
            alert(`Schedule "${scheduleName}" saved!`);
        }

        function renderSavedSchedulesList() {
            const listContainer = document.getElementById('saved-schedules-list');
            if (!listContainer) return; 
            if (savedSchedules.length === 0) {
                listContainer.innerHTML = '<p class="text-muted">No schedules saved yet. Generate and save some!</p>';
                return;
            }
            listContainer.innerHTML = savedSchedules.map(item => `
                <div class="saved-schedule-item">
                    <div>
                        <div class="saved-schedule-item-name">${item.name}</div>
                        <div class="saved-schedule-item-details">
                            Saved: ${item.timestamp} | Courses: ${item.data.courses.map(c => c.section_id.split('*')[0]+'*'+c.section_id.split('*')[1]).join(', ')}
                        </div>
                    </div>
                    <div class="saved-schedule-item-actions button-group">
                        <button class="btn-custom btn-accent btn-sm" onclick="loadSavedScheduleFromStorage('${item.id}')">Load</button>
                        <button class="btn-custom btn-secondary-custom btn-sm" onclick="deleteScheduleFromStorage('${item.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function loadSavedScheduleFromStorage(scheduleId) {
            const scheduleItem = savedSchedules.find(s => s.id === scheduleId);
            if (!scheduleItem) {
                alert("Saved schedule not found.");
                return;
            }
<<<<<<< HEAD
            // Instead of re-rendering the main grid, directly show the modal
            // We still need currentResultsData to have this one item for viewScheduleDetail to work
            currentResultsData = {
                combinations: [scheduleItem.data],
                stats: { total_found: 1, processing_time: "N/A" }
            };
            viewScheduleDetail(0); // View the first (and only) schedule in this temporary set

            document.getElementById('saved-schedules-panel').style.display = 'none'; 
=======
            currentResultsData = {
                combinations: [scheduleItem.data], 
                stats: { total_found: 1, processing_time: "N/A" } 
            };
            currentPage = 1;
            displayPaginatedResults();
            document.getElementById('saved-schedules-panel').style.display = 'none'; 
            const resultsSection = document.querySelector('.results-display-section');
            if (resultsSection) {
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }
>>>>>>> refs/remotes/main/main
        }

        function deleteScheduleFromStorage(scheduleId) {
            if (!confirm("Are you sure you want to delete this saved schedule?")) return;
            savedSchedules = savedSchedules.filter(s => s.id !== scheduleId);
            persistSavedSchedules();
            renderSavedSchedulesList();
        }

        function formatTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h < 10 ? '0' : ''}${h}:${m < 10 ? '0' : ''}${m}`;
        }

        function showLoading() { document.getElementById('loading-overlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }

    </script>
</body>
</html>